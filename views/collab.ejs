<%- include('partials/header') %>

<div class="container mx-auto mt-10 p-4">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-4xl font-bold"><%= doc.name %></h1>
        <div id="connection-status" class="text-sm font-semibold px-3 py-1 rounded-full">
            Connecting...
        </div>
    </div>
    <div id="editor" class="border rounded-lg shadow-lg"></div>
</div>

<div id="initial-content" style="display: none;"><%- JSON.stringify(doc.content) %></div>

<script type="module">
    import * as Y from 'yjs';
    import { WebsocketProvider } from 'y-websocket';
    import { CodemirrorBinding } from 'y-codemirror';
    import { EditorView, basicSetup } from 'codemirror';
    import { EditorState } from '@codemirror/state';
    import { javascript } from '@codemirror/lang-javascript';

    const statusIndicator = document.getElementById('connection-status');
    const doc = new Y.Doc();
    
    // Use the URL provided by the server
    const wsProvider = new WebsocketProvider(`wss://${window.location.host}`, '<%= doc.docId %>', doc);

    const user = JSON.parse('<%- JSON.stringify(user) %>');
    wsProvider.awareness.setLocalStateField('user', {
        name: user.username,
        color: '#' + Math.floor(Math.random()*16777215).toString(16)
    });

    wsProvider.on('status', event => {
        console.log(event.status); // logs "connected" or "disconnected"
        if (event.status === 'connected') {
            statusIndicator.textContent = 'Connected';
            statusIndicator.className = 'text-sm font-semibold px-3 py-1 rounded-full bg-green-500 text-white';
        } else {
            statusIndicator.textContent = 'Disconnected';
            statusIndicator.className = 'text-sm font-semibold px-3 py-1 rounded-full bg-red-500 text-white';
        }
    });

    const ytext = doc.getText('codemirror');
    
    // Safely get content from the hidden div
    const initialContent = JSON.parse(document.getElementById('initial-content').textContent || '""');
    ytext.insert(0, initialContent);

    const editorContainer = document.getElementById('editor');

    const state = EditorState.create({
        doc: ytext.toString(),
        extensions: [basicSetup, javascript()]
    });

    const view = new EditorView({
        state,
        parent: editorContainer
    });

    const binding = new CodemirrorBinding(ytext, view, wsProvider.awareness);

    // --- AWARENESS ---
    wsProvider.awareness.on('change', () => {
        const cursors = [];
        wsProvider.awareness.getStates().forEach((state, clientID) => {
            if (clientID !== wsProvider.awareness.clientID && state.user) {
                const user = state.user;
                const cursor = document.createElement('span');
                cursor.className = 'cm-y-cursor';
                cursor.style.borderColor = user.color;
                const name = document.createElement('div');
                name.className = 'cm-y-cursor-name';
                name.style.backgroundColor = user.color;
                name.textContent = user.name;
                cursor.appendChild(name);
                cursors.push({ dom: cursor, pos: -1 });
            }
        });
        // This is a simplified cursor rendering. A full implementation
        // would require more logic to position the cursors correctly.
        // For now, this shows who is connected.
    });


    // Save changes back to the database periodically
    let saveTimeout;
    ytext.observe(event => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            fetch(`/collab/<%= doc._id %>/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: ytext.toString() })
            });
        }, 2000); // Save 2 seconds after the last change
    });
</script>

<%- include('partials/footer') %>
